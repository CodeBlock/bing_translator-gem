<p>I'm trying to use Bing Translator SOAP API (due to in HTTP API I'm getting 414 "Request too long" for not so big requests due to UTF-8 serialization).</p>

<p>So, I'm playing with <a href="https://github.com/CodeBlock/bing_translator-gem" rel="nofollow">bing_translator gem source</a> trying to switch it from HTTP inerface to SOAP one using Savon SOAP toolkit.</p>

<p>My workflow as follows (<a href="https://github.com/CodeBlock/bing_translator-gem/blob/bcf80ca47628f50d4714e1802d5602b5018bc6ed/lib/bing_translator.rb#L143" rel="nofollow">access token getting function</a> not shown):</p>

<pre><code>WSDL_URI = 'http://api.microsofttranslator.com/V2/soap.svc?wsdl'

get_access_token
client = Savon.client(wsdl: WSDL_URI, headers: {'Authorization' =&gt; "Bearer #{@access_token['access_token']}"})

params = {
  'from'        =&gt; 'ru',
  'to'          =&gt; 'en',
  'text'        =&gt; 'Это текст для перевода',
  'category'    =&gt; 'general',
  'contentType' =&gt; 'text/plain'
}

result = client.call(:translate, message: params)
</code></pre>

<p>Then SOAP request executes:</p>

<pre><code>SOAP request: http://api.microsofttranslator.com/V2/soap.svc

Authorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=invest_amurobl_ru&amp;http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fdatamarket.accesscontrol.windows.net%2f&amp;Audience=http%3a%2f%2fapi.microsofttranslator.com&amp;ExpiresOn=1381128612&amp;Issuer=https%3a%2f%2fdatamarket.accesscontrol.windows.net%2f&amp;HMACSHA256=Mw41PMMgw2n6ZVaGRXtwfR0vwMJUyIMltIyd9pa9MqA%3d
SOAPAction: "http://api.microsofttranslator.com/V2/LanguageService/Translate"
Content-Type: text/xml;charset=UTF-8
Content-Length: 454

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;env:Envelope xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:wsdl="http://tempuri.org/" xmlns:env="http://schemas.xmlsoap.org/soap/envelope/"&gt;
&lt;env:Body&gt;
&lt;wsdl:Translate&gt;
&lt;to&gt;en&lt;/to&gt;
&lt;text&gt;Это текст для перевода&lt;/text&gt;
&lt;category&gt;general&lt;/category&gt;
&lt;contentType&gt;text/html&lt;/contentType&gt;
&lt;from&gt;ru&lt;/from&gt;
&lt;/wsdl:Translate&gt;
&lt;/env:Body&gt;
&lt;/env:Envelope&gt;
</code></pre>

<p>And I'm getting error 500: <code>Unhandled Service Exception</code></p>

<pre><code>&lt;s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"&gt;
&lt;s:Body&gt;
&lt;s:Fault&gt;
&lt;faultcode&gt;s:Client&lt;/faultcode&gt;
&lt;faultstring xml:lang="en-US"&gt;Unhandled Service Exception&lt;/faultstring&gt;
&lt;detail&gt;
&lt;int xmlns="http://schemas.microsoft.com/2003/10/Serialization/"&gt;1&lt;/int&gt;
&lt;/detail&gt;
&lt;/s:Fault&gt;
&lt;/s:Body&gt;
&lt;/s:Envelope&gt;
</code></pre>

<p>What's may be wrong? Can anyone who already using Bing Translator SOAP API to diff my soap-messages with yourself? Any advices to how to troubleshoot this.</p>

<p>Thanks for attention.</p>

<p><strong>EDIT:</strong></p>

<p>I've checked API with SoapUI, as @SteffenRoller advices and it works. Here is XML generated by SoapUI (values are inserted by hand):</p>

<pre><code>&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:v2="http://api.microsofttranslator.com/V2"&gt;
   &lt;soapenv:Header/&gt;
   &lt;soapenv:Body&gt;
      &lt;v2:Translate&gt;
         &lt;!--Optional:--&gt;
         &lt;v2:text&gt;Текст, который я хочу перевести&lt;/v2:text&gt;
         &lt;!--Optional:--&gt;
         &lt;v2:from&gt;ru&lt;/v2:from&gt;
         &lt;!--Optional:--&gt;
         &lt;v2:to&gt;en&lt;/v2:to&gt;
         &lt;!--Optional:--&gt;
         &lt;v2:contentType&gt;text/plain&lt;/v2:contentType&gt;
         &lt;!--Optional:--&gt;
         &lt;v2:category&gt;general&lt;/v2:category&gt;
      &lt;/v2:Translate&gt;
   &lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;
</code></pre>

<p>As you can see the only difference is that all the tags inside a <code>&lt;Body&gt;</code> are in the <code>v2</code> namespace. In the XML, generated by Savon this namespace isn't present at all.</p>

<p>So, now question is: <strong>How to instruct Savon to use correct namespace for tags inside the message body?</strong></p>

<p>Although, I think, this is a Savon bug, I'll file it to developers, as SoapUI have generated correct XML by the same WSDL, and Savon doesn't.</p>

<p>Okay. This is a known bug: <a href="https://github.com/savonrb/savon/issues/340" rel="nofollow">Savon issue #340</a>. It's related to composite WSDL files and won't bi fixed in current major release :-(</p>

<p>So, in our case we need to tell Savon, what is our namespace is, what is it's name (just to align it with WSDL) and prepend each tag's name with this namespace.</p>

<p>The correct code looks like this:</p>

<pre><code>require 'savon'

access_token = "http%3a%2f%2fschemas.xmlsoap.org%2fws...CA9TEs%3d"

client = Savon.client(
  wsdl: 'http://api.microsofttranslator.com/V2/soap.svc?wsdl',
  namespace: 'http://api.microsofttranslator.com/V2',
  namespace_identifier: :v2,
  headers: {'Authorization' =&gt; "Bearer #{access_token}"},
)

params = {
  'v2:text'        =&gt; 'Это текст для перевода',
  'v2:from'        =&gt; 'ru',
  'v2:to'          =&gt; 'en',
  'v2:contentType' =&gt; 'text/plain',
  'v2:category'    =&gt; 'general',
}

result = client.call(:translate, message: params)

puts result.body[:translate_response][:translate_result]
</code></pre>

<p>Any advices and corrections are welcome. Thanks.</p>
